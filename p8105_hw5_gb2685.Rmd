---
title: "Homework 5"
author: "Gauri Bhatkhande"
date: "18/11/2020"
output: github_document
editor_options: 
  chunk_output_type: console
---
```{r setup, include = FALSE}
library(tidyverse)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set (theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)


scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d

```


## Problem 1 

```{r}
homicide_df = 
  read_csv("Data/homicide-data.csv") %>%
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition ==  "Closed by arrest"      ~ "solved",
    )
  ) %>%
  select(city_state, resolved) %>%
  filter(city_state != "Tulsa_AL")
```

Looking at this a bit 

```{r}
aggregate_df = 
  homicide_df %>% 
  group_by(city_state) %>% 
  summarize (
    hom_total = n(),
    hom_unsolved = sum(resolved == "unsolved")
  )
```

Can I do a prop test for a single city?

```{r}
prop.test(
  aggregate_df %>% filter( city_state == "Baltimore_MD") %>% pull(hom_unsolved),
  aggregate_df %>% filter( city_state == "Baltimore_MD") %>% pull(hom_total)) %>% 
  broom::tidy()

```

Try to iterate

```{r}
results_df = 
  aggregate_df %>%
  mutate(
    prop_tests = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>%
  select(city_state, estimate, conf.low, conf.high)
```



```{r}

results_df %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  theme(axis.text.x= element_text(angle = 90, vjust = 0.5, hjust = 1 ))
```


```{r}
homicide_df = 
  read_csv("Data/homicide-data.csv") %>%
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition ==  "Closed by arrest"      ~ "solved",
    )
  ) %>%
  select(city_state, resolved) %>%
  filter(city_state != "Tulsa_AL") %>% 
  nest(data = resolved)
```

## Problem 2 

*Creating a tidy dataframe:*

```{r}

files = list.files(path = "Prob2data", full.names = TRUE)

long_study = files  %>%
  set_names() %>%
  map_dfr(read_csv, .id = "file_name")%>%
  separate(file_name, c("dir","arm","subject_id","ext"))%>%
  select(-c(dir,ext))%>%
  pivot_longer(week_1:week_8, 
               names_to= "week_number", 
               values_to="observation") 

long_study
```

*Making a spaghetti plot:* 

```{r}
long_study %>%
ggplot( aes(week_number, observation, group = paste(subject_id, arm), color = arm)) + geom_line() +
labs (
  x = "week number",
  y = "values"
)
```

## Problem 3 

Creating a function so that a sample of size 30 is taken and then the ttest is run on it to get the estimate and p values. Also used tidy from broom to get estimate and p value from the messy output. 

```{r}
library(broom)
set.seed(1)

sim_normal_ttest = function(n =30, mu, sigma = 5) {
  
  sim_data = tibble(
    x = rnorm(n, mean = mu, sd = sigma),
  )
  
  sim_data %>% 
  t.test()%>%
  tidy() %>%
  select (c(estimate, p.value))
  
}

```

Running the above function 5000 times: 

```{r}
sim_results = 
  rerun(5000, sim_normal_ttest(30, 0, 5)) %>% 
  bind_rows()
```

Running the above function 5000 times for every different mu: 

```{r}
sim_results = 
  tibble(mu = c(0,1,2,3,4,5,6)) %>% 
  mutate(
    output_lists = map(.x = mu, ~rerun(5000, sim_normal_ttest(mu = .x))),
    estimate_dfs = map(output_lists, bind_rows)) %>% 
  select(-output_lists) %>% 
  unnest(estimate_dfs)
```



